<%
  contracts = [FinePrint.get_contract(:general_terms_of_use),
               FinePrint.get_contract(:privacy_policy)]

  contract_links = contracts.collect { |contract|
    link_to(contract.title, term_path(contract), target: '_blank')
    # TODO: show them in a modal instead of new tab
    # link_to contract.title, term_path(contract), remote: true
  }

  @min_passw_length ||= Identity::MIN_PASSWORD_LENGTH

  user_from_signed_params = session[:user_from_signed_params] || {}

%>

<div id="login-signup-form">
  <div class="content">
    <%= render partial: 'tab_group', locals: { active_class: 'signup--active'} %>

    <%= newflow_login_signup_card(
          header: (I18n.t(:"login_signup_form.signup_page_header")),
          current_step: I18n.t(:"login_signup_form.step_counter", current_step: 1, total_steps: 2),
          classes: 'signup-page') do %>
      <% lev_form_for :signup, url: educator_signup_post_path do |f| %>
        <% fh = NewflowFormHelper::Newflow.new(f: f,
                                               context: self,
                                               errors: @handler_result&.errors) %>
        <div class="content role-section">
          <div>
            <%= render partial: 'back_arrow', locals: { path: newflow_signup_path } %>
            <div class="role-button"><%= I18n.t(:"login_signup_form.educator") %></div>
          </div>
        </div>

        <div class="content required-fields-notice">
          <%= I18n.t(:"login_signup_form.all_fields_required") %>
        </div>

        <div class="content control-group">
          <%= label_tag :first_name, I18n.t(:"login_signup_form.legal_first_name_label"),
                        class: 'field-label'
          %>
          <%= fh.text_field name: :first_name,
                            placeholder: I18n.t(:"login_signup_form.legal_first_name_label"),
                            value: user_from_signed_params['first_name'],
                            autofocus: true
          %>
        </div>

        <div class="content control-group">
          <%=
            label_tag :last_name, I18n.t(:"login_signup_form.legal_last_name_label"),
                      class: 'field-label'
          %>
          <%=
            fh.text_field name: :last_name,
                          placeholder: I18n.t(:"login_signup_form.legal_last_name_label"),
                          value: user_from_signed_params['last_name']
          %>
        </div>

        <div class="content control-group">
          <%= label_tag :phone_number, I18n.t(:"login_signup_form.phone_number_label"), class: 'field-label' %>
          <%=
            f.text_field :phone_number,
                         type: 'tel',
                         class: 'int-country-code form-control wide',
                         placeholder:  I18n.t(:'login_signup_form.phone_number_placeholder'),
                         onkeydown: 'javascript:backspacerDOWN(this,event);',
                         onkeyup: 'javascript:backspacerUP(this,event);'

          %>
        </div>

        <div class="content control-group">
          <%= label_tag :email, I18n.t(:"login_signup_form.school_issued_email_label"), class: 'field-label' %>
          <%=
            fh.text_field(
              name: :email,
              value: user_from_signed_params.dig('signed_external_data', 'email'),
              placeholder: I18n.t(:"login_signup_form.school_issued_email_placeholder")
            )
          %>
        </div>

        <%# Hide the password field if student contains signed parameters %>
        <%#     which means they're coming from an LMS %>
        <div class="content control-group">
          <div id="password-field-container">
            <div class="input-with-tooltip">
              <%= label_tag :password, I18n.t(:"login_signup_form.password_label"),
                            class: 'field-label'
              %>
              <%= render partial: 'password_show_hide'  %>
              <%=
                fh.text_field(
                  name: :password,
                  type: :password,
                  placeholder: I18n.t(:"login_signup_form.password_label")
                )
              %>
              <%= render partial: 'password_tooltip' %>
            </div>
          </div>
        </div>

        <div class="content control-group checkboxes-section">
          <div class="terms">
            <label>
              <%= f.check_box :newsletter, checked: true %>
              <span><%= I18n.t(:"login_signup_form.send_me_newsletter") %></span>
            </label>
            <br>
          </div>

          <div class="terms">
            <label>
              <%= f.check_box :terms_accepted %>

              <span>
                                <%= I18n.t(:"login_signup_form.agree_to_terms_of_use",
                                           terms_of_use: contract_links.first,
                                           privacy_policy: contract_links.second).html_safe
                                %>
                            </span>
            </label>
            <%= f.hidden_field :contract_1_id, value: contracts.first.id %>
            <%= f.hidden_field :contract_2_id, value: contracts.second.id %>
            <%= f.hidden_field :role, value: :instructor %>
          </div>
        </div>

        <div class="content">
          <%= f.submit I18n.t(:"login_signup_form.continue_button"),
                       data: { disable_with: I18n.t(:"login_signup_form.continue_button") },
                       class: 'primary', id: 'signup_form_submit_button',
                       :data => {ga_category: 'Account Creation', ga_action: 'Click', ga_label: '3A-Email'} %>
        </div>
      <% end %>
    <% end %>
  </div>
</div>

<script type="text/javascript">
  Accounts.Ui.enableOnChecked('#signup_form_submit_button', '#signup_terms_accepted');
</script>
