<% if Settings::Salesforce.show_support_chat == true %>
<script type='text/javascript'>
function initEmbeddedMessaging() {
    try {
        embeddedservice_bootstrap.settings.language = 'en_US';

        embeddedservice_bootstrap.init(
            '00DU0000000Kwch',
            'Web_Messaging_Deployment',
            'https://openstax.my.site.com/ESWWebMessagingDeployme1716235390398',
            {scrt2URL: 'https://openstax.my.salesforce-scrt.com'}
        );
    } catch (err) {
        console.error('Error loading Embedded Messaging: ', err);
    }
}

//Passing Web Context to Prechat - BEGIN
<% unless current_user.is_anonymous? %>
var sFirstName = "<%= current_user&.first_name %>";
var sLastName = "<%= current_user&.last_name %>";
var sEmail = "<%= current_user&.email_addresses&.last&.value %>";
var sSchool = "<%= current_user&.school&.name %>";
var sOpenStax_UUID = "<%= current_user&.uuid %>";

window.addEventListener("onEmbeddedMessagingReady", e => {
    //log event
    console.log("onEmbeddedMessagingReady event triggered");

    //set visible prechat field
    embeddedservice_bootstrap.prechatAPI.setVisiblePrechatFields({
        // List the pre-chat field names with the value and whether
        // it's editable in the pre-chat form.
        "_firstName": {
          "value": sFirstName,
          "isEditableByEndUser": false
        },
        "_lastName": {
          "value": sLastName,
          "isEditableByEndUser": false
        },
        "_email": {
          "value": sEmail,
          "isEditableByEndUser": false
        },
        "School": {
          "value": sSchool,
          "isEditableByEndUser": true
        }
    });

    //Set invisible prechat field
    embeddedservice_bootstrap.prechatAPI.setHiddenPrechatFields({
        "OpenStax_UUID" : sOpenStax_UUID
    });
});
//Passing Web Context to Prechat - END
<% end %>
</script>
<script type='text/javascript' src='https://openstax.my.site.com/ESWWebMessagingDeployme1716235390398/assets/js/bootstrap.min.js' onload='initEmbeddedMessaging()'></script>
<% end %>
